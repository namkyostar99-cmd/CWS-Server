{% extends 'layout.html' %}

{% block title %}CCTV ê´€ì œì‹¤ - í™ˆ{% endblock %}

{% block user_area %}
<a class="btn" href="{{ url_for('monitoring') }}">ëª¨ë‹ˆí„°ë§ ì‹œì‘</a>
{% endblock %}

{% block content %}
<div class="page" id="overview">
    <h2>ğŸ¥ CCTV ê´€ì œ ì‹¤ì‹œê°„ í˜„í™©</h2>
    
    <div class="video-card" style="margin-bottom: 20px;">
        <div class="video-frame" style="background: #000; border-radius: 8px; overflow: hidden; position: relative; min-height: 400px;">
            <video id="video-feed" src="{{ current_stream }}" controls autoplay muted style="width: 100%; display: block;"></video>
            
            <div id="stream-overlay" style="position: absolute; top: 10px; left: 10px; color: #00ff00; font-size: 0.8rem; background: rgba(0,0,0,0.5); padding: 2px 5px; pointer-events: none;">
                LIVE FEED
            </div>

            <input type="file" id="videoUploader" style="display: none;" accept="video/*">
            <button id="uploadTrigger" style="position: absolute; bottom: 10px; right: 10px; background: rgba(0,0,0,0.7); color: white; border: 1px solid #555; padding: 5px 10px; cursor: pointer; border-radius: 4px;">ì˜ìƒ ì—…ë¡œë“œ</button>
        </div>
    </div>

    <div class="card" style="width: 100%; margin-bottom: 20px; background: #2a2a2a; border: 1px solid #444;">
        <h3 style="margin-top: 0;">ğŸŒ ìŠ¤íŠ¸ë¦¬ë° ì£¼ì†Œ ì„¤ì •</h3>
        <div style="display: flex; gap: 10px;">
            <input type="text" id="indexServerAddr" value="{{ current_stream }}" 
                   style="flex: 1; padding: 10px; border-radius: 4px; border: 1px solid #555; background: #1a1a1a; color: white;">
            <button id="applyStreamBtn" class="btn primary">ì£¼ì†Œ ì ìš©</button>
        </div>
    </div>

    <div class="cards">
        <div class="card">ì¹´ë©”ë¼<br/><span class="big">12</span></div>
        <div class="card">ì•ŒëŒ<br/><span class="big">3</span></div>
        <div class="card">ì—°ê²° ìƒíƒœ<br/><span class="big">Good</span></div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
{% endblock %}

{% block extra_js %}
<script>
    // 1. HLS ì¬ìƒ ì´ˆê¸°í™” (JS íŒŒì¼ ìˆ˜ì • ì—†ì´ HTML ë‚´ì—ì„œ ì²˜ë¦¬)
    const video = document.getElementById('video-feed');
    const m3u8Url = "{{ current_stream }}";

    if (m3u8Url.includes('.m3u8')) {
        if (Hls.isSupported()) {
            const hls = new Hls();
            hls.loadSource(m3u8Url);
            hls.attachMedia(video);
            hls.on(Hls.Events.MANIFEST_PARSED, () => video.play());
        } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
            video.src = m3u8Url;
        }
    }

    // 2. ì£¼ì†Œ ì ìš© ë²„íŠ¼ ë¡œì§
    document.getElementById('applyStreamBtn').addEventListener('click', () => {
        const newUrl = document.getElementById('indexServerAddr').value;
        
        fetch('/api/set_stream', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ url: newUrl })
        })
        .then(res => res.json())
        .then(data => {
            if(data.status === "success") {
                alert("ìŠ¤íŠ¸ë¦¬ë° ì£¼ì†Œê°€ ê°±ì‹ ë˜ì—ˆìŠµë‹ˆë‹¤.");
                location.reload(); // ìƒˆë¡œê³ ì¹¨í•˜ì—¬ ìƒˆë¡œìš´ ìŠ¤íŠ¸ë¦¼ ë¡œë“œ
            }
        })
        .catch(err => alert("ì—ëŸ¬ ë°œìƒ: " + err));
    });
</script>
{% endblock %}