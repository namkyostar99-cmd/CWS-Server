{% extends 'layout.html' %}

{% block content %}
<div class="main-body" style="padding: 20px;">
    <div class="card" style="margin-bottom: 20px; background: #2a2a2a; padding: 20px; border-radius: 8px;">
        <h2 style="margin: 0; color: #fff;">ğŸ“Š ì‹¤ì‹œê°„ í†µê³„</h2>
        <p style="font-size: 1.2rem; color: #ccc;">
            í˜„ì¬ê¹Œì§€ DBì— ê¸°ë¡ëœ ìœ„ë°˜ ê±´ìˆ˜: <span id="violation-count" style="color: #ff4757; font-weight: bold;">{{ violations|length }}</span> ê±´
        </p>
    </div>

    <div class="card" style="margin-bottom: 20px; background: #000; border-radius: 8px; overflow: hidden;">
        <video id="video-player" controls autoplay muted style="width: 100%; max-height: 500px;"></video>
    </div>

    <div class="card" style="background: #2a2a2a; padding: 20px; border-radius: 8px;">
        <h3 style="color: #fff; margin-top: 0;">ğŸ“¹ ìŠ¤íŠ¸ë¦¬ë° ì œì–´</h3>
        <div style="display: flex; gap: 10px;">
            <select id="url-list-box" style="flex: 1; padding: 12px; background: #1a1a1a; color: white; border: 1px solid #444; border-radius: 4px;">
                <option value="{{ current_stream }}">í˜„ì¬ ì¬ìƒ ì¤‘ì¸ URL</option>
                {% for config in url_list %}
                <option value="{{ config.stream_url }}">{{ config.stream_url }}</option>
                {% endfor %}
            </select>
            <button class="btn primary" onclick="updateStreamUrl()" style="padding: 0 25px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">URL ê°±ì‹ </button>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<script>
    // ë¹„ë””ì˜¤ ì¬ìƒ ë¡œì§ (HLS ì§€ì›)
    const video = document.getElementById('video-player');
    const videoSrc = "{{ current_stream }}";

    if (Hls.isSupported()) {
        const hls = new Hls();
        hls.loadSource(videoSrc);
        hls.attachMedia(video);
    } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
        video.src = videoSrc;
    }

    // URL ê°±ì‹  í•¨ìˆ˜
    function updateStreamUrl() {
        const selectedUrl = document.getElementById('url-list-box').value;
        fetch('/api/set_stream', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ url: selectedUrl })
        })
        .then(res => res.json())
        .then(data => {
            if(data.status === 'success') {
                alert('URLì´ ê°±ì‹ ë˜ì—ˆìŠµë‹ˆë‹¤.');
                location.reload();
            }
        });
    }
</script>
{% endblock %}