{% extends 'layout.html' %}

{% block content %}
<div class="page" id="live">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <div>
            <button class="btn" onclick="loadTable('config')" style="margin-right: 5px;">í…Œì´ë¸”1 (ì„¤ì •)</button>
            <button class="btn" onclick="loadTable('violations')">í…Œì´ë¸”2 (ê¸°ë¡)</button>
        </div>
        <button class="btn primary" onclick="refreshCurrentTable()">ğŸ”„ ì‹¤ì‹œê°„ ê°±ì‹ </button>
    </div>

    <h3 style="color: #fff;">ğŸ“ í˜„ì¬ DB: <span id="tableNameDisplay" style="color: #00ff00;">violations</span></h3>

    <div class="table-container" style="max-height: 600px; overflow-y: auto; background: #1a1a1a; border: 1px solid #444; border-radius: 8px;">
        <table id="dbDataTable" style="width: 100%; border-collapse: collapse; color: #ccc; text-align: left;">
            <thead id="tableHead" style="background: #333; position: sticky; top: 0;">
                </thead>
            <tbody id="tableBody">
                </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let currentTableType = 'violations';

    function loadTable(type) {
        currentTableType = type;
        document.getElementById('tableNameDisplay').textContent = type === 'config' ? 'stream_config' : 'violations';
        
        // ì‹¤ì œ API í˜¸ì¶œ (ì˜ˆì‹œ ì£¼ì†Œ)
        fetch(`/api/get_table_data?type=${type}`)
            .then(res => res.json())
            .then(data => renderDataTable(data));
    }

    function renderDataTable(data) {
        const head = document.getElementById('tableHead');
        const body = document.getElementById('tableBody');
        head.innerHTML = '';
        body.innerHTML = '';

        if (data.length === 0) {
            body.innerHTML = '<tr><td colspan="5" style="padding: 20px; text-align: center;">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
            return;
        }

        // 1. í—¤ë” ìƒì„± (ë°ì´í„°ì˜ í‚¤ê°’ ê¸°ì¤€)
        const keys = Object.keys(data[0]);
        const trHead = document.createElement('tr');
        keys.forEach(key => {
            const th = document.createElement('th');
            th.style = "padding: 12px; border-bottom: 1px solid #444;";
            th.textContent = key.toUpperCase();
            trHead.appendChild(th);
        });
        head.appendChild(trHead);

        // 2. ë°”ë”” ìƒì„±
        data.forEach(row => {
            const tr = document.createElement('tr');
            keys.forEach(key => {
                const td = document.createElement('td');
                td.style = "padding: 12px; border-bottom: 1px solid #333;";
                // ì¦ê±° URL(ì´ë¯¸ì§€)ì¸ ê²½ìš° ë§í¬ë‚˜ ì¸ë„¤ì¼ë¡œ í‘œì‹œ
                if (key === 'evidence_url' || key === 'image') {
                    td.innerHTML = `<a href="${row[key]}" target="_blank" style="color: #00ff00;">ë³´ê¸°</a>`;
                } else {
                    td.textContent = row[key];
                }
                tr.appendChild(td);
            });
            body.appendChild(tr);
        });
    }

    function refreshCurrentTable() {
        loadTable(currentTableType);
    }

    // ì´ˆê¸° ë¡œë“œ
    document.addEventListener('DOMContentLoaded', () => loadTable('violations'));
</script>
{% endblock %}