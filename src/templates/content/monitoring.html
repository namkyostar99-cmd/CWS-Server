{% extends 'layout.html' %}

{% block content %}
<!-- ì¦ê±° ì´ë¯¸ì§€ ëª¨ë‹¬ (íŒì—… ì°¨ë‹¨ ìš°íšŒ) -->
<div id="evidence-modal" onclick="closeModal()" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.85); z-index:9999; flex-direction:column; align-items:center; justify-content:center; gap:16px;">
  <div style="position:relative;" onclick="event.stopPropagation()">
    <div id="evidence-loading" style="display:none; color:#fff; font-size:1rem; text-align:center; padding:40px;">â³ ì´ë¯¸ì§€ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    <img id="evidence-img" src="" alt="" style="max-width:90vw; max-height:80vh; border-radius:8px; box-shadow:0 0 40px rgba(0,0,0,0.8); display:block;">
  </div>
  <div style="display:flex; gap:12px; align-items:center;" onclick="event.stopPropagation()">
    <span id="evidence-filename" style="color:#aaa; font-size:12px; font-family:monospace;"></span>
    <a id="evidence-download" href="#" download style="background:#007bff; color:white; padding:8px 18px; border-radius:6px; text-decoration:none; font-size:13px; font-weight:bold;">â¬‡ ë‹¤ìš´ë¡œë“œ</a>
    <button onclick="closeModal()" style="background:#555; color:white; border:none; padding:8px 18px; border-radius:6px; cursor:pointer; font-size:13px;">âœ• ë‹«ê¸°</button>
  </div>
  <p style="color:#666; font-size:11px;">í™”ë©´ ë°”ê¹¥ì„ í´ë¦­í•˜ê±°ë‚˜ ESCë¡œ ë‹«ê¸°</p>
</div>

<div class="main-body" style="padding: 20px; background: #1a1b1e; min-height: 100vh;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; background: #2b2c32; padding: 15px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.3);">
        <div style="display: flex; gap: 10px;">
            <button class="ctrl-btn" onclick="loadTableData('1')" id="btn-tab1">ğŸ› ï¸ í…Œì´ë¸”1 (ì„¤ì •)</button>
            <button class="ctrl-btn" onclick="loadTableData('2')" id="btn-tab2">ğŸš¨ í…Œì´ë¸”2 (ê¸°ë¡)</button>
        </div>
        <button class="ctrl-btn refresh" onclick="refreshTable()">ğŸ”„ ì‹¤ì‹œê°„ ë°ì´í„° ê°±ì‹ </button>
    </div>

    <div style="margin-bottom: 15px; padding-left: 5px;">
        <h3 style="color: #adb5bd; margin: 0; font-weight: 400;">
            í˜„ì¬ í™œì„± í…Œì´ë¸”: <span id="table-title" style="color: #007bff; font-weight: 700; text-transform: uppercase;">violations</span>
        </h3>
    </div>

    <div class="table-container" style="background: #2b2c32; border-radius: 10px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.5);">
        <div style="max-height: 650px; overflow-y: auto;">
            <table id="db-data-table" style="width: 100%; border-collapse: collapse; color: #e9ecef; text-align: left; font-size: 0.95rem;">
                <thead id="thead" style="background: #343a40; position: sticky; top: 0; z-index: 10;">
                    </thead>
                <tbody id="tbody">
                    <tr>
                        <td colspan="10" style="padding: 40px; text-align: center; color: #6c757d;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<style>
    /* ì»¨íŠ¸ë¡¤ ë²„íŠ¼ ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
    .ctrl-btn {
        padding: 10px 20px;
        background: #3e4048;
        color: white;
        border: 1px solid #4d4f58;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.2s;
    }
    .ctrl-btn:hover { background: #4e505a; }
    .ctrl-btn.active { background: #007bff; border-color: #0056b3; }
    .ctrl-btn.refresh { background: #28a745; border-color: #1e7e34; }
    .ctrl-btn.refresh:hover { background: #218838; }

    /* í…Œì´ë¸” í–‰ í˜¸ë²„ íš¨ê³¼ */
    #tbody tr:hover { background: rgba(255, 255, 255, 0.05); }
    th, td { padding: 15px; border-bottom: 1px solid #3e4048; }
</style>

<script>
    let currentType = '2'; // ê¸°ë³¸ê°’ì€ ìœ„ë°˜ ê¸°ë¡(2)

    // 1. APIë¥¼ í†µí•´ DB ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
    function loadTableData(type) {
        currentType = type;
        
        // ë²„íŠ¼ í™œì„±í™” ìŠ¤íƒ€ì¼ ì œì–´
        document.getElementById('btn-tab1').classList.toggle('active', type === '1');
        document.getElementById('btn-tab2').classList.toggle('active', type === '2');

        // app.pyì˜ @app.route('/api/get_table_data') í˜¸ì¶œ
        fetch(`/api/get_table_data?type=${type}`)
            .then(res => {
                if (!res.ok) throw new Error('Network response was not ok');
                return res.json();
            })
            .then(response => {
                // app.pyì—ì„œ ë‚´ë ¤ì£¼ëŠ” table_nameê³¼ data ì‚¬ìš©
                document.getElementById('table-title').textContent = response.table_name;
                renderTable(response.data);
            })
            .catch(err => {
                console.error("Fetch error:", err);
                document.getElementById('tbody').innerHTML = 
                    `<tr><td colspan="10" style="text-align:center; color:#ff4757; padding:20px;">
                        ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: API ì—”ë“œí¬ì¸íŠ¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.
                    </td></tr>`;
            });
    }

// 2. ë°ì´í„°ë¥¼ í…Œì´ë¸” í˜•ì‹ìœ¼ë¡œ í™”ë©´ì— ê·¸ë¦¬ëŠ” í•¨ìˆ˜
    function renderTable(data) {
        const thead = document.getElementById('thead');
        const tbody = document.getElementById('tbody');
        thead.innerHTML = '';
        tbody.innerHTML = '';

        if (!data || data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="10" style="padding: 40px; text-align: center;">ì¡°íšŒëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
            return;
        }

        // í—¤ë” ìƒì„± (ë°ì´í„°ì˜ í‚¤ê°’ì„ ê¸°ë°˜ìœ¼ë¡œ ìë™ ìƒì„±)
        const headers = Object.keys(data[0]);
        const trHead = document.createElement('tr');
        headers.forEach(h => {
            const th = document.createElement('th');
            th.textContent = h.replace('_', ' ').toUpperCase();
            trHead.appendChild(th);
        });
        thead.appendChild(trHead);

        // ë°ì´í„° í–‰ ìƒì„±
        data.forEach(row => {
            const tr = document.createElement('tr');
            headers.forEach(h => {
                const td = document.createElement('td');
                
                // [ìˆ˜ì • ë¡œì§] ì¦ê±°ë³´ê¸° ì²˜ë¦¬: ì¤‘ì•™ ì„œë²„ì˜ í”„ë¡ì‹œ ì—”ë“œí¬ì¸íŠ¸ë¥¼ í˜¸ì¶œ
                if (h === 'evidence_url' && row[h]) {
                    // URLì—ì„œ íŒŒì¼ëª…ë§Œ ì¶”ì¶œ (ì˜ˆ: v_1_1234.jpg)
                    const parts = row[h].split('/');
                    const filename = parts[parts.length - 1];
                    
                    td.innerHTML = `
                        <button onclick="openEvidenceProxy('${filename}')" 
                                style="background:#007bff; border:none; color:white; cursor:pointer; padding:6px 12px; border-radius:4px; font-weight:bold;">
                            ğŸ“¸ ì¦ê±°ë³´ê¸°
                        </button>`;
                } else {
                    td.textContent = row[h] !== null ? row[h] : '-';
                }
                tr.appendChild(td);
            });
            tbody.appendChild(tr);
        });
    }

    // [ìˆ˜ì •] íŒì—… ëŒ€ì‹  ëª¨ë‹¬ë¡œ ì¦ê±° ì´ë¯¸ì§€ í‘œì‹œ (íŒì—… ì°¨ë‹¨ ë¬¸ì œ ì™„ì „ í•´ê²°)
    function openEvidenceProxy(filename) {
        if (!filename || filename === '-' || filename.includes('undefined')) {
            alert('ìœ íš¨í•œ íŒŒì¼ëª…ì´ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }
        const proxyUrl = `/view_evidence/${filename}`;
        const modal = document.getElementById('evidence-modal');
        const img = document.getElementById('evidence-img');
        const loading = document.getElementById('evidence-loading');
        const dlLink = document.getElementById('evidence-download');
        const fnLabel = document.getElementById('evidence-filename');

        // ë¡œë”© ìƒíƒœ í‘œì‹œ
        img.style.display = 'none';
        loading.style.display = 'block';
        modal.style.display = 'flex';
        fnLabel.textContent = filename;
        dlLink.href = proxyUrl;
        dlLink.download = filename;

        // ì´ë¯¸ì§€ ë¡œë“œ
        img.onload = () => { loading.style.display = 'none'; img.style.display = 'block'; };
        img.onerror = () => { loading.textContent = 'âŒ ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨ â€” ì—£ì§€ ì„œë²„ ì—°ê²°ì„ í™•ì¸í•˜ì„¸ìš”'; loading.style.display = 'block'; img.style.display = 'none'; };
        img.src = proxyUrl;
    }

    function closeModal() {
        const modal = document.getElementById('evidence-modal');
        const img = document.getElementById('evidence-img');
        modal.style.display = 'none';
        img.src = '';  // ìš”ì²­ ì¤‘ë‹¨
    }

    // 4. ë°ì´í„° ê°±ì‹  ë²„íŠ¼ í•¨ìˆ˜
    function refreshTable() {
        loadTableData(currentType);
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ í…Œì´ë¸”2(ìœ„ë°˜ ê¸°ë¡)ë¥¼ ê¸°ë³¸ìœ¼ë¡œ ë³´ì—¬ì¤Œ
    window.onload = () => {
        loadTableData('2');
        // ESC í‚¤ë¡œ ëª¨ë‹¬ ë‹«ê¸°
        document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeModal(); });
    };
</script>
{% endblock %}