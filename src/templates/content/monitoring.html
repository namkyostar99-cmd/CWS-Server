{% extends 'layout.html' %}

{% block content %}
<div class="main-body" style="padding: 20px; background: #1a1b1e; min-height: 100vh;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; background: #2b2c32; padding: 15px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.3);">
        <div style="display: flex; gap: 10px;">
            <button class="ctrl-btn" onclick="loadTableData('1')" id="btn-tab1">ğŸ› ï¸ í…Œì´ë¸”1 (ì„¤ì •)</button>
            <button class="ctrl-btn" onclick="loadTableData('2')" id="btn-tab2">ğŸš¨ í…Œì´ë¸”2 (ê¸°ë¡)</button>
        </div>
        <button class="ctrl-btn refresh" onclick="refreshTable()">ğŸ”„ ì‹¤ì‹œê°„ ë°ì´í„° ê°±ì‹ </button>
    </div>

    <div style="margin-bottom: 15px; padding-left: 5px;">
        <h3 style="color: #adb5bd; margin: 0; font-weight: 400;">
            í˜„ì¬ í™œì„± í…Œì´ë¸”: <span id="table-title" style="color: #007bff; font-weight: 700; text-transform: uppercase;">violations</span>
        </h3>
    </div>

    <div class="table-container" style="background: #2b2c32; border-radius: 10px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.5);">
        <div style="max-height: 650px; overflow-y: auto;">
            <table id="db-data-table" style="width: 100%; border-collapse: collapse; color: #e9ecef; text-align: left; font-size: 0.95rem;">
                <thead id="thead" style="background: #343a40; position: sticky; top: 0; z-index: 10;">
                    </thead>
                <tbody id="tbody">
                    <tr>
                        <td colspan="10" style="padding: 40px; text-align: center; color: #6c757d;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<style>
    /* ì»¨íŠ¸ë¡¤ ë²„íŠ¼ ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
    .ctrl-btn {
        padding: 10px 20px;
        background: #3e4048;
        color: white;
        border: 1px solid #4d4f58;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.2s;
    }
    .ctrl-btn:hover { background: #4e505a; }
    .ctrl-btn.active { background: #007bff; border-color: #0056b3; }
    .ctrl-btn.refresh { background: #28a745; border-color: #1e7e34; }
    .ctrl-btn.refresh:hover { background: #218838; }

    /* í…Œì´ë¸” í–‰ í˜¸ë²„ íš¨ê³¼ */
    #tbody tr:hover { background: rgba(255, 255, 255, 0.05); }
    th, td { padding: 15px; border-bottom: 1px solid #3e4048; }
</style>

<script>
    let currentType = '2'; // ê¸°ë³¸ê°’ì€ ìœ„ë°˜ ê¸°ë¡(2)

    // 1. APIë¥¼ í†µí•´ DB ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
    function loadTableData(type) {
        currentType = type;
        
        // ë²„íŠ¼ í™œì„±í™” ìŠ¤íƒ€ì¼ ì œì–´
        document.getElementById('btn-tab1').classList.toggle('active', type === '1');
        document.getElementById('btn-tab2').classList.toggle('active', type === '2');

        // app.pyì˜ @app.route('/api/get_table_data') í˜¸ì¶œ
        fetch(`/api/get_table_data?type=${type}`)
            .then(res => {
                if (!res.ok) throw new Error('Network response was not ok');
                return res.json();
            })
            .then(response => {
                // app.pyì—ì„œ ë‚´ë ¤ì£¼ëŠ” table_nameê³¼ data ì‚¬ìš©
                document.getElementById('table-title').textContent = response.table_name;
                renderTable(response.data);
            })
            .catch(err => {
                console.error("Fetch error:", err);
                document.getElementById('tbody').innerHTML = 
                    `<tr><td colspan="10" style="text-align:center; color:#ff4757; padding:20px;">
                        ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: API ì—”ë“œí¬ì¸íŠ¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.
                    </td></tr>`;
            });
    }

    // 2. ë°ì´í„°ë¥¼ í…Œì´ë¸” í˜•ì‹ìœ¼ë¡œ í™”ë©´ì— ê·¸ë¦¬ëŠ” í•¨ìˆ˜
    function renderTable(data) {
        const thead = document.getElementById('thead');
        const tbody = document.getElementById('tbody');
        thead.innerHTML = '';
        tbody.innerHTML = '';

        if (!data || data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="10" style="padding: 40px; text-align: center;">ì¡°íšŒëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
            return;
        }

        // í—¤ë” ìƒì„± (ë°ì´í„°ì˜ í‚¤ê°’ì„ ê¸°ë°˜ìœ¼ë¡œ ìë™ ìƒì„±)
        const headers = Object.keys(data[0]);
        const trHead = document.createElement('tr');
        headers.forEach(h => {
            const th = document.createElement('th');
            th.textContent = h.replace('_', ' ').toUpperCase();
            trHead.appendChild(th);
        });
        thead.appendChild(trHead);

        // ë°ì´í„° í–‰ ìƒì„±
        data.forEach(row => {
            const tr = document.createElement('tr');
            headers.forEach(h => {
                const td = document.createElement('td');
                
                // ì¦ê±°ë³´ê¸° URL ì²˜ë¦¬ (about:blank ì°¨ë‹¨ ë°©ì§€ ë¡œì§ ì ìš©)
                if (h === 'evidence_url' && row[h]) {
                    td.innerHTML = `
                        <button onclick="openEvidence('${row[h]}')" 
                                style="background:none; border:none; color:#3498db; cursor:pointer; text-decoration:underline; font-weight:bold; padding:0;">
                            [ì¦ê±°ë³´ê¸°]
                        </button>`;
                } else {
                    td.textContent = row[h] !== null ? row[h] : '-';
                }
                tr.appendChild(td);
            });
            tbody.appendChild(tr);
        });
    }

    // 3. ë³´ì•ˆ ì°¨ë‹¨ ìš°íšŒìš© ì¦ê±°ì°½ ì—´ê¸° í•¨ìˆ˜
    function openEvidence(url) {
        if (!url || url === '-' || url.includes('undefined')) {
            alert("ìœ íš¨í•œ ì¦ê±° URLì´ ì—†ìŠµë‹ˆë‹¤.");
            return;
        }
        
        console.log("ì‹œë„ ì¤‘ì¸ URL:", url);
        
        // <a> íƒœê·¸ì˜ ìë™ ì´ë™ì´ ì°¨ë‹¨ë  ë•Œë¥¼ ëŒ€ë¹„í•´ JSë¡œ íŒì—… ìƒì„±
        // ë¸Œë¼ìš°ì € íŒì—… ì°¨ë‹¨ ì„¤ì •ì´ ë˜ì–´ìˆì„ ê²½ìš° í—ˆìš©ì´ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        const win = window.open(url, '_blank', 'noopener,noreferrer');
        if (win) {
            win.focus();
        } else {
            // íŒì—…ì´ ì°¨ë‹¨ëœ ê²½ìš° ìˆ˜ë™ ë³µì‚¬ ìœ ë„
            alert("íŒì—…ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ íŒì—…ì„ í—ˆìš©í•´ì£¼ì„¸ìš”.\nURL: " + url);
        }
    }

    // 4. ë°ì´í„° ê°±ì‹  ë²„íŠ¼ í•¨ìˆ˜
    function refreshTable() {
        loadTableData(currentType);
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ í…Œì´ë¸”2(ìœ„ë°˜ ê¸°ë¡)ë¥¼ ê¸°ë³¸ìœ¼ë¡œ ë³´ì—¬ì¤Œ
    window.onload = () => loadTableData('2');
</script>
{% endblock %}