{% extends 'layout.html' %}

{% block content %}
<div class="main-body" style="padding: 20px;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <div>
            <button onclick="loadTableData('1')" style="padding: 10px 20px; cursor: pointer;">í…Œì´ë¸”1 (ì„¤ì •)</button>
            <button onclick="loadTableData('2')" style="padding: 10px 20px; cursor: pointer;">í…Œì´ë¸”2 (ê¸°ë¡)</button>
        </div>
        <button class="btn primary" onclick="refreshTable()" style="padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 4px;">ğŸ”„ ì‹¤ì‹œê°„ ê°±ì‹ </button>
    </div>

    <h3 style="color: #fff; margin-bottom: 10px;">ğŸ“ í˜„ì¬ ì¡°íšŒ ì¤‘ì¸ í…Œì´ë¸”: <span id="table-title" style="color: #ffc107;">violations</span></h3>

    <div class="table-wrapper" style="background: #2a2a2a; border-radius: 8px; overflow-x: auto; max-height: 600px;">
        <table id="db-data-table" style="width: 100%; border-collapse: collapse; color: #ddd; text-align: left;">
            <thead id="thead" style="background: #333; position: sticky; top: 0;">
                </thead>
            <tbody id="tbody">
                </tbody>
        </table>
    </div>
</div>

<script>
    let currentType = '2'; 

    function loadTableData(type) {
        currentType = type;
        // app.pyì— ì •ì˜ëœ ì •í™•í•œ ê²½ë¡œì¸ /api/get_table_dataë¡œ í˜¸ì¶œ
        fetch(`/api/get_table_data?type=${type}`)
            .then(res => {
                if (!res.ok) throw new Error('API ê²½ë¡œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return res.json();
            })
            .then(response => {
                // app.py ì‘ë‹µ í‚¤ê°€ "table_name"ì´ë¯€ë¡œ ì´ì— ë§ì¶° ìˆ˜ì •
                document.getElementById('table-title').textContent = response.table_name;
                renderTable(response.data);
            })
            .catch(err => {
                console.error("Fetch error:", err);
                document.getElementById('tbody').innerHTML = '<tr><td colspan="10">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</td></tr>';
            });
    }

    function renderTable(data) {
        const thead = document.getElementById('thead');
        const tbody = document.getElementById('tbody');
        thead.innerHTML = '';
        tbody.innerHTML = '';

        if (!data || data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="10" style="padding: 20px; text-align: center;">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
            return;
        }

        // í—¤ë” ìƒì„±
        const headers = Object.keys(data[0]);
        const trHead = document.createElement('tr');
        headers.forEach(h => {
            const th = document.createElement('th');
            th.style = "padding: 15px; border-bottom: 2px solid #444; background: #333;";
            th.textContent = h.toUpperCase();
            trHead.appendChild(th);
        });
        thead.appendChild(trHead);

        // ë°ì´í„° í–‰ ìƒì„±
        data.forEach(row => {
            const tr = document.createElement('tr');
            headers.forEach(h => {
                const td = document.createElement('td');
                td.style = "padding: 12px; border-bottom: 1px solid #333;";
                
                if (h === 'evidence_url') {
                    td.innerHTML = `<a href="${row[h]}" target="_blank" style="color: #007bff;">[ì¦ê±°ë³´ê¸°]</a>`;
                } else {
                    td.textContent = row[h];
                }
                tr.appendChild(td);
            });
            tbody.appendChild(tr);
        });
    }

    function refreshTable() {
        loadTableData(currentType);
    }

    window.onload = () => loadTableData('2');
</script>
{% endblock %}